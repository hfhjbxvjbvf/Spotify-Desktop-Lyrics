# 接口逻辑汇总

> 目标：为后续 SpotifyDesktopElectron 接口适配提供参考。内容覆盖 Spotify-lyrics-window（Python/PyQt）与 SpotifyWeb（Chrome 扩展）两份项目的接口逻辑。

## 一、Spotify-lyrics-window（Python / PyQt）

### 1. 认证与用户控制（Spotify Web API）
- **授权入口**：`https://accounts.spotify.com/authorize`
- **换取/刷新 Token**：`https://accounts.spotify.com/api/token`
- **回调地址**：`http://127.0.0.1:8888/callback`
- **播放控制接口**：`/v1/me/player/*`
  - 当前播放：`/v1/me/player/currently-playing`
  - 播放/暂停：`/v1/me/player/play`、`/v1/me/player/pause`
  - 上一首/下一首：`/v1/me/player/previous`、`/v1/me/player/next`
  - 跳转进度：`/v1/me/player/seek?position_ms=...`
  - 设备列表：`/v1/me/player/devices`

### 2. 歌词获取（Spotify + 第三方）
- **Spotify 搜索/曲目信息**：
  - 搜索：`https://api.spotify.com/v1/search`
  - 曲目：`https://api.spotify.com/v1/tracks/{id}`
- **Spotify 歌词接口**：
  - `https://spclient.wg.spotify.com/color-lyrics/v2/track/{id}?format=json&market=from_token`
- **Spotify 歌词 Token 获取（sp_dc）**：
  - 入口：`https://open.spotify.com/get_access_token?reason=transport&productType=web_player`
  - 通过 `sp_dc` + server time + TOTP 生成 token

- **网易云歌词接口**：
  - 搜索：`https://music.163.com/api/search/get/web`
  - 详情：`http://music.163.com/api/song/detail`
  - 歌词：`http://music.163.com/api/song/lyric`

- **酷狗歌词接口**：
  - 搜索：`http://mobilecdn.kugou.com/api/v3/search/song`
  - 详情：`http://m.kugou.com/app/i/getSongInfo.php`
  - 歌词：`http://lyrics.kugou.com/download`

### 3. 多源歌词策略
- 基于 Spotify 曲目信息进行多源搜索（网易云/酷狗），使用相似度评分选择最优结果
- Spotify 歌词接口失败时回退到第三方接口
- 本地缓存：
  - 歌词文件（`.mrc/.lrc/.krc`）
  - 元数据文件：`lyric.json`

### 4. 播放状态来源
- Windows：WinRT `GlobalSystemMediaTransportControlsSessionManager`
- Linux：MPRIS / DBus


## 二、SpotifyWeb（Chrome 扩展）

### 1. 播放状态采集
- 内容脚本从 Spotify 页面 DOM/MediaSession 获取播放状态
- 通过 `chrome.runtime.sendMessage` 向后台发送：`SPOTIFY_PLAYBACK_UPDATE`

### 2. Token 与歌词获取
- **Token**：
  - `https://open.spotify.com/get_access_token?reason=transport&productType=web_player`
  - 由页面端或后台请求，优先利用已登录态
- **Spotify 歌词**：
  - `https://spclient.wg.spotify.com/color-lyrics/v2/track/{id}?format=json&market=from_token`
- **公共歌词兜底**：
  - LRCLIB：`https://lrclib.net/api/get` / `https://lrclib.net/api/search`
  - lyrics.ovh：`https://api.lyrics.ovh/v1/{artist}/{title}`

### 3. 本地缓存与通信
- IndexedDB：`spotify_lyrics_db / lyrics`
- 端口消息：
  - `LYRICS_STATE_UPDATE`
  - `LYRICS_UPDATE_SETTINGS`
  - `LYRICS_IMPORT`
  - `LYRICS_AI_REQUEST`

### 4. AI 生成歌词（可选）
- 硅基流动：`https://api.siliconflow.cn/v1/chat/completions`
- 需要 API Key


## 三、适配建议（供 SpotifyDesktopElectron 参考）

### 1. 接口优先级建议
1) Spotify 歌词接口（优先）
2) LRCLIB（次优）
3) lyrics.ovh（最后兜底）

### 2. 关键能力
- 支持多接口共存与失败自动切换
- 可选本地缓存（避免频繁请求）
- 尽量复用 Spotify 登录态（或 sp_dc）

> 说明：若有“仅真实歌词、不使用 AI 生成”的需求，请禁用 AI 生成路径，直接走真实歌词接口。
